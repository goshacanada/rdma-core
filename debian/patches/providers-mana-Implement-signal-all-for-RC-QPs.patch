From: Konstantin Taranov <kotaranov@microsoft.com>
Date: Wed, 31 Jul 2024 11:02:40 +0200
Subject: providers/mana: Implement signal all for RC QPs

Implement signal all for RC QPs

Signed-off-by: Konstantin Taranov <kotaranov@microsoft.com>
Origin: upstream, https://github.com/linux-rdma/rdma-core/pull/1556
---
 providers/mana/mana.h | 1 +
 providers/mana/qp.c   | 1 +
 providers/mana/wr.c   | 5 +++--
 3 files changed, 5 insertions(+), 2 deletions(-)

diff --git a/providers/mana/mana.h b/providers/mana/mana.h
index c0ac97b..29350d7 100644
--- a/providers/mana/mana.h
+++ b/providers/mana/mana.h
@@ -127,6 +127,7 @@ struct mana_qp {
 	};
 
 	enum ibv_mtu mtu;
+	int sq_sig_all;
 
 	struct shadow_queue shadow_rq;
 	struct shadow_queue shadow_sq;
diff --git a/providers/mana/qp.c b/providers/mana/qp.c
index 4591cee..67c945b 100644
--- a/providers/mana/qp.c
+++ b/providers/mana/qp.c
@@ -236,6 +236,7 @@ static struct ibv_qp *mana_create_qp_rc(struct ibv_pd *ibpd,
 
 	pthread_spin_init(&qp->sq_lock, PTHREAD_PROCESS_PRIVATE);
 	pthread_spin_init(&qp->rq_lock, PTHREAD_PROCESS_PRIVATE);
+	qp->sq_sig_all = attr->sq_sig_all;
 
 	if (create_shadow_queue(&qp->shadow_sq, attr->cap.max_send_wr,
 				sizeof(struct rc_sq_shadow_wqe))) {
diff --git a/providers/mana/wr.c b/providers/mana/wr.c
index 755e6a8..5661045 100644
--- a/providers/mana/wr.c
+++ b/providers/mana/wr.c
@@ -273,6 +273,7 @@ static inline int
 mana_ib_rc_post_send_request(struct mana_qp *qp, struct ibv_send_wr *wr,
 			     struct rc_sq_shadow_wqe *shadow_wqe)
 {
+	bool signaled = ((wr->send_flags & IBV_SEND_SIGNALED) != 0) || qp->sq_sig_all;
 	enum  gdma_work_req_flags flags = GDMA_WORK_REQ_NONE;
 	struct extra_large_wqe extra_wqe = {0};
 	struct rdma_send_oob send_oob = {0};
@@ -304,7 +305,7 @@ mana_ib_rc_post_send_request(struct mana_qp *qp, struct ibv_send_wr *wr,
 
 	send_oob.wqe_type = convert_wr_to_hw_opcode(wr->opcode);
 	send_oob.fence = (wr->send_flags & IBV_SEND_FENCE) != 0;
-	send_oob.signaled = (wr->send_flags & IBV_SEND_SIGNALED) != 0;
+	send_oob.signaled = signaled;
 	send_oob.solicited = (wr->send_flags & IBV_SEND_SOLICITED) != 0;
 	send_oob.psn = qp->rc_qp.sq_psn;
 	send_oob.ssn = qp->rc_qp.sq_ssn;
@@ -350,7 +351,7 @@ mana_ib_rc_post_send_request(struct mana_qp *qp, struct ibv_send_wr *wr,
 
 	shadow_wqe->header.wr_id = wr->wr_id;
 	shadow_wqe->header.opcode = convert_wr_to_wc(wr->opcode);
-	shadow_wqe->header.flags = (wr->send_flags & IBV_SEND_SIGNALED) ? 0 : MANA_NO_SIGNAL_WC;
+	shadow_wqe->header.flags = signaled ? 0 : MANA_NO_SIGNAL_WC;
 	shadow_wqe->header.posted_wqe_size_in_bu = gdma_wqe.size_in_bu;
 	shadow_wqe->header.unmasked_queue_offset = gdma_wqe.unmasked_wqe_index;
 	shadow_wqe->end_psn = PSN_DEC(qp->rc_qp.sq_psn);
